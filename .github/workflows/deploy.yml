name: Deploy to Railway

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up environment variables
        run: |
          echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" >> $GITHUB_ENV
          echo "LOGIN_URL=${{ secrets.LOGIN_URL }}" >> $GITHUB_ENV
          echo "USER_NAME=${{ secrets.USER_NAME }}" >> $GITHUB_ENV
          echo "USER_PASSWORD=${{ secrets.USER_PASSWORD }}" >> $GITHUB_ENV
          echo "RAILWAY_API_TOKEN=${{ secrets.RAILWAY_TOKEN }}" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip xvfb libxi6 libgconf-2-4
          wget -q -O google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome.deb || sudo apt-get -fy install
          sudo ln -s /usr/bin/google-chrome /usr/bin/chrome || true

      - name: Install ChromeDriver
        run: |
          wget -N https://chromedriver.storage.googleapis.com/126.0.6478.126/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip -d /usr/local/bin/
          sudo rm chromedriver_linux64.zip 
          sudo chmod +x /usr/local/bin/chromedriver
          sudo ln -s /usr/local/bin/chromedriver /usr/bin/chromedriver || true
          
      - name: Locate ChromeDriver and check permissions
        run: |
          echo "Locating chromedriver..."
          CHROMEDRIVER_PATH=$(which chromedriver)
          echo "ChromeDriver Path: $CHROMEDRIVER_PATH"
          if [ -z "$CHROMEDRIVER_PATH" ]; then
            echo "chromedriver not found in PATH"
            exit 1
          fi
          echo "Checking ChromeDriver permissions..."
          ls -la $CHROMEDRIVER_PATH

      - name: Verify ChromeDriver Installation
        run: |
          echo "Checking /usr/bin directory:"
          ls -la /usr/bin/
          echo "Checking ChromeDriver version in /usr/bin:"
          /usr/bin/chromedriver --version

      - name: Display Google Chrome Version
        run: |
          echo "Google Chrome version:"
          google-chrome --version || echo "Google Chrome not found"

      - name: Install Railway CLI
        run: |
          curl -sSL https://raw.githubusercontent.com/railwayapp/cli/master/install.sh | sh
          echo 'export PATH="$HOME/.railway/bin:$PATH"' >> $GITHUB_ENV

      - name: Configure Railway project
        run: |
          mkdir -p ~/.railway
          echo '{"project": "1dac405b-26b4-431c-bbcb-a9b598bc0e89"}' > ~/.railway/project.json
        env:
          export PATH: "$HOME/.railway/bin:$PATH"

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_TOKEN: "1dac405b-26b4-431c-bbcb-a9b598bc0e89"
        run: |
          . $GITHUB_ENV
          railway up --service atec --environment production
